<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" name="viewport">
	<meta content="yes" name="apple-mobile-web-app-capable">
	<meta content="black" name="apple-mobile-web-app-status-bar-style">
	<meta content="telephone=no" name="format-detection">
	<meta content="email=no" name="format-detection">
	<title>自定义缓冲滚动</title>

	<style>
		*{padding:0;margin:0;}
		ul{
			list-style: none;
		}
		body{background-color: #f8f8f8;min-height: 500px;padding-bottom: 300px;}
		#scrollWraper{width: 80%;margin:10px auto;border:1px solid #ccc;overflow: hidden;height: 300px;position: relative;}
		#scrollWraper #scrollContent{background-color: #fff;z-index:1;position: relative;}
		#scrollWraper .refresh{line-height: 40px;text-align: center;position: absolute;top:0;left:0;width: 100%;z-index:0;}
		#scrollWraper .more{line-height: 40px;text-align: center;position: absolute;bottom:0;left:0;width: 100%;z-index:0;}
		#scrollContent  li{line-height: 40px;text-align: center;border-top: 1px solid #f2f2f2;}
		dl{padding:10px;}
		dl dt{line-height: 30px;color:#f93;}
		dl dd{line-height: 20px;color:#666;font-size: 14px;}

		.swiper{
			height: 100px;
			overflow: hidden;
			border: 1px solid #f93;
			margin:10px auto;
			width:80%;
		}
		.swiper ul{
			width: 300%;
			height: 100%;
		}
		.swiper ul li{
			width: 33.33%;
			height: 100%;
			float: left;
		}
		.swiper ul li{text-align: center;line-height: 100px;color: #333;font-size: 24px;}
		.swiper ul li.gray{background-color:#e8e8e8}
		.swiper ul li.orange{background-color:#f93}
		.swiper ul li.red{background-color:#f33}

	</style>
</head>
<body>
	<dl>
		<dt>实现功能</dt>
		<dd>1.滚动条</dd>
		<dd>2.上拉刷新</dd>
		<dd>3.下拉加载</dd>
		<dd>4.区块滚动 snap</dd>
		<dd>5.轮播图</dd>
		<dd>6.接口化，插件化，模块化</dd>
		<dd>7.惯性设置，边界超出设置</dd>
		<dd>8.拖动粘性</dd>
	</dl>
	<dl>
		<dt>技术难点</dt>
		<dd>1.缓冲运动</dd>
		<dd>2.边界问题</dd>
		<dd>3.刷新</dd>
		<dd>4.加载</dd>
		<dd>5.速度计算</dd>
		<dd>6.缓冲目标位就算</dd>
		<dd>7.动画结束回调</dd>
	</dl>
	<dl>
		<dt>注意</dt>
		<dd>1.可以模仿bscroller去做一些适配和兼容性</dd>
	</dl>
	<div id="scrollWraper">
		<ul id="scrollContent">
			<li>1</li>
			<li>2</li>
			<li>3</li>
			<li>4</li>
			<li>5</li>
			<li>6</li>
			<li>7</li>
			<li>8</li>
			<li>9</li>
			<li>10</li>
			<li>11</li>
			<li>12</li>
			<li>13</li>
			<li>14</li>
			<li>15</li>
			<li>16</li>
			<li>17</li>
			<li>18</li>
			<li>19</li>
			<li>20</li>
			<li>21</li>
			<li>22</li>
			<li>23</li>
			<li>24</li>
			<li>25</li>
			<li>26</li>
			<li>27</li>
			<li>28</li>
			<li>29</li>
			<li>30</li>
		</ul>
		<h4 class="refresh">下拉刷新</h4>
		<p class="more">加载更多</p>
	</div>
	
	<div id="swiperWraper" class="swiper">
		<ul id="scrollContent" >
			<li class="gray">1</li>
			<li class="orange">2</li>
			<li class="red">3</li>
		</ul>
	</div>

	<script>

		function extend(target,src){//对象扩展
			for(key in src){
				target[key]=src[key];
			}
		};

		var vendor = (function() {//浏览器供应商 获取浏览器前缀

			var elementStyle=document.createElement("div").style;
			var transformNames = {
			   webkit: 'webkitTransform',
			   Moz: 'MozTransform',
			   O: 'OTransform',
			   ms: 'msTransform',
			   standard: 'transform'
			};

			for (var key in transformNames) {
			   if (elementStyle[transformNames[key]] !== undefined) {
			      return key;
			   }
			}

			return false;
		})();

		var prefixStyle=function(style){//获取兼容各浏览器前缀样式
			if(vendor==false){
				return false;
			}
			if(vendor=="standard"){
				return style;
			}
			else{
				return vendor+style.charAt(0).toUpperCase()+style.substr(1);
			}
		};

		var caculateSpeed=function(arr){//[{x:x,y:y,time:timeStap}]

			var dur=arr[arr.length-1].time-arr[0].time;
			var dis_x=arr[arr.length-1].x-arr[0].x;
			var dis_y=arr[arr.length-1].y-arr[0].y;

			return {
				"speed-x":dis_x/dur,
				"speed-y":dis_y/dur
			}
		}

		//下拉刷新
		//1.执行刷新的动作在end事件里面  如果正在加载，不会多次调用
		//2.企图刷新的话   move事件里面需要修改提示语

		function WYscroller(el,options){
			this.options={
				startX:0,
				startY:0,
				scrollY: true,//滚动方向
				adjustTime:"400ms",//松手后自适应时间
				snapTime:"600ms",
				scrollBar:false,//是否需要滚动条
				snap:false,//是否分隔
				loop:false,
				autoPlay:false,
				touchstart:function(){},
				touchmove:function(){},
				touchend:function(){},
				reload:function(){},//在配置了下拉刷新的时候需要此配置项
			};
			this.transType={
				"ease":"cubic-bezier(.25,.1,.25,1)",
				"linear":"cubic-bezier(0,0,1,1)",
				"ease-in":"cubic-bezier(.42,0,1,1)",
				"ease-out":"cubic-bezier(0,0,.58,1)",
				"test":"cubic-bezier(.27,.08,.38,.97)",
				"slowdown":"cubic-bezier(.33,.47,.35,.91)"
			};
			extend(this.options,options);
			this.wraper=typeof el=="string"?document.queryselector(el):el;//外层元素
			this.inner=this.wraper.children[0];//包含的滚动元素
			this.refreshDom=this.options.refreshEle;
			this.moreDom=this.options.moreEle;
			var direction=this.direction=!this.options.scrollY?"x":"y";
			this.sizeName=direction=="x"?"clientWidth":"clientHeight";
			this.speed=0;//手指滑动速度
			this.dragSlowLength=direction=="y"?this.wraper.offsetHeight*0.25:this.wraper.offsetWidth*0.25;//容器尺寸的4分之一
			this.reloading=false;//正在下拉重新加载
			this.down=false;//手指已按下
			
			
			this.init();//初始化
		}

		WYscroller.prototype={ 
			init:function(){
				var self=this;
				
				self.initScroll();

				self.refreshDom&&self.initRefresh();
				self.moreDom&&self.initMore();
				self.options.scrollBar&&self.initScrollBar();

			},
			initScroll:function(){
				var self=this;
				var startX=self.options.startX+"px";
				var startY=self.options.startY+"px";

				//过渡函数 过渡时间 过渡终点位置

				!self.options.snap&&self.setTransition(self.inner,"ease","0ms",{x:self.options.startX,y:self.options.startY});
				self.options.snap&&self.initSnap();
				
				self.wraper.addEventListener("touchstart",self.startHandler.bind(self));
				self.wraper.addEventListener("touchmove",self.moveHandler.bind(self));
				self.wraper.addEventListener("touchend",self.endHandler.bind(self));
				self.inner.addEventListener(prefixStyle("transitionEnd"),function(){//from to curIndex
					// console.log("transitionEnd"+self.snapIndex);
					self.snapIndex=self.getNearIndex(self.getRelativePos());
					if(self.options.loop){
						if(self.snapIndex==self.snapNum){
							self.setTransition(self.inner,"ease","0ms",{x:0,y:0});
							// self.snapIndex=0;
						}
					}
				});
			},
			initRefresh:function(){
				var self=this;
				self.setTransition(self.refreshDom,"ease","0ms",{x:0,y:-self.refreshDom.offsetHeight});
			},
			initMore:function(){
				var self=this;
				self.setTransition(self.moreDom,"ease","0ms",{x:0,y:self.moreDom.offsetHeight});
			},
			initSnap:function(){//手指点住屏幕的时候如何中断滑动动画
				var self=this;
				var children=self.inner.children;
				var itemNum=self.snapNum=children.length;
				var innerItem0=children[0];
				var copy0=innerItem0.cloneNode(true);
				
				self.snapIndex=self.options.startIndex||0;
				var sizeName=self.sizeName;

				self.innerSize=self.inner[sizeName];
				self.innerItemSize=innerItem0[sizeName];
				self.wraperSize=self.wraper[sizeName];
				
				if(self.options.loop){//循环
					
					self.inner.appendChild(copy0);

					self.inner.style.width=(itemNum+1)*self.wraperSize+"px";
					for(var i=0;i<itemNum+1;i++){
						self.inner.children[i].style.width=self.wraperSize+"px";
					}
					
				}

				!self.options.autoPlay&&self.goIndex(self.snapIndex);
				self.options.autoPlay&&self.play();
			},
			play:function(){
				var self=this;
				self.snapInterval=setInterval(function(){
					!self.down&&self.next();
				},3000);
			},
			initScrollBar:function(){
				var self=this;

				var innerH=self.inner.offsetHeight;
				var wraperH=self.wraper.offsetHeight;
				var scale=innerH / wraperH;
				var barSize=wraperH / scale;
				var innerIndex=window.getComputedStyle(self.inner).zIndex;
				var bar=self.bar=document.createElement("div");
				bar.style.display="block";
				bar.style.position="absolute";
				bar.style.top=0;
				bar.style.right=0;
				bar.style.width="4px";
				bar.style.height=barSize+"px";
				bar.style.backgroundColor="#e3e3e3";
				bar.style.zIndex=innerIndex+1;
				bar.style.borderRadius="2px";
				self.wraper.style.position="relative";

				self.barSize=barSize;
				self.wraper.appendChild(bar);
			},
			scrollBar:function(){
				var self=this;
				var innerH=self.inner.offsetHeight;
				var wraperH=self.wraper.offsetHeight;
				var scale=innerH / wraperH;
				var barSize=wraperH / scale;


			},
			startHandler:function(e){
				e.preventDefault();
				this.down=true;
				var self=this;
				var touch=e.touches[0];

				var click_finger_x=self.click_finger_x=touch.clientX;
				var click_finger_y=self.click_finger_y=touch.clientY;

				var relative_pos=self.click_relative_pos=self.getRelativePos();
				self.fingerArray=[];
				self.fingerArray.push({x:click_finger_x,y:click_finger_y,time:new Date()*1});

				self.setTransition(self.inner,"ease","0ms",{x:relative_pos.x,y:relative_pos.y});

				self.options.touchstart&&self.options.touchstart.call(self,relative_pos);//滚动监听
				// console.log(touch,click_finger_x,click_finger_y,self.client_pos,relative_pos);
			},
			moveHandler:function(e){
				e.preventDefault();
				var self=this;
				var touch=e.touches[0];
				var move_finger_x=self.move_finger_x=touch.clientX;
				var move_finger_y=self.move_finger_y=touch.clientY;
				var sizeName=self.sizeName;// clientWidth clientHeight

				var length=2;
				if(self.fingerArray.length<length){
					self.fingerArray.push({x:move_finger_x,y:move_finger_y,time:new Date()*1});
				}
				else{
					self.fingerArray=self.fingerArray.slice(1);
					self.fingerArray.push({x:move_finger_x,y:move_finger_y,time:new Date()*1});
				}
				var speedX=self.speedX=caculateSpeed(self.fingerArray)["speed-x"];
				var speedY=self.speedY=caculateSpeed(self.fingerArray)["speed-y"];
				self.speed=self.direction=="x"?speedX:speedY;

				var relative_pos={
					x:self.move_finger_x-self.click_finger_x+self.click_relative_pos.x,
					y:self.move_finger_y-self.click_finger_y+self.click_relative_pos.y
				};

				//边界拖动抵抗
				var resistDistance=self.dragSlowLength;
				
				// if(relative_pos.y>resistDistance){
				// 	var deta=resistDistance/(relative_pos.y-resistDistance);
				// 	relative_pos.y=resistDistance+(relative_pos.y-resistDistance) * deta;


				// 	// console.log("draft");
				// 	// var deta=(relative_pos.y-resistDistance)/(resistDistance*resistDistance);
				// 	// relative_pos.y-=relative_pos.y*deta;
				// }

				self.setTransform(self.inner,relative_pos);
				
				
				// console.log(self.move_finger_y,self.click_finger_y,self.click_relative_pos.y,relative_pos);


				if(self.refreshDom){
					if(relative_pos.y<=self.refreshDom[sizeName]){
						self.setTransform(self.refreshDom,{x:relative_pos.x,y:relative_pos.y-self.refreshDom[sizeName]});
						!self.reloading&&!(self.refreshDom.innerHTML="下拉刷新123");
					}
					else{
						self.setTransform(self.refreshDom,{x:relative_pos.x,y:0});
						!self.reloading&&!(self.refreshDom.innerHTML="松开刷新");
					}
				}
				
				if(self.options.scrollBar){//需要滚动条
					var top=-relative_pos.y*self.barSize/self.wraper[sizeName];
					self.setTransform(self.bar,{x:0,y:top});
				}

				self.options.touchmove&&self.options.touchmove.call(self,relative_pos);//滚动监听
				
				// console.log(self.fingerArray,speedX,speedY);
			},
			endHandler:function(e){//这里的逻辑比较复杂  考虑到各种情况
				e.preventDefault();
				this.down=false;
				var self=this;
				var relative_pos=self.getRelativePos();
				var adjust=self.options.adjustTime;
				var sizeName=self.sizeName;// clientWidth clientHeight

				var tapType=self.tapType(self.fingerArray,new Date()*1);
				if(tapType=="tap"||tapType=="longtap"){//点按或者长按
					return ;
				}
				if(relative_pos[self.direction]>0){//企图刷新 顶部或左边漏出
					if(self.refreshDom){//需要下拉刷新 Y
						if(relative_pos.y<self.refreshDom[sizeName]){
							self.setTransition(self.inner,"ease",adjust,{x:0,y:0});
							self.refreshDom&&self.setTransition(self.refreshDom,"ease",adjust,{x:0,y:-self.refreshDom[sizeName]});
							// self.refreshDom&&self.setTransition(self.inner,"test",adjust,{x:0,y:self.refreshDom.offsetHeight});
						}
						else{//触发刷新动作

							if(self.refreshDom){//需要下拉刷新
								self.setTransition(self.inner,"ease",adjust,{x:0,y:self.refreshDom[sizeName]});
								!self.reloading&&!(self.refreshDom.innerHTML="加载中");
								!self.reloading&&self.options.reload&&self.options.reload.apply(self);//执行重新加载回调函数
								self.reloading=true;//正在加载
							}
							else{
								self.setTransition(self.inner,"ease",adjust,{x:0,y:0});
							}
						}
					}
					else{//不需要刷新 Y X

						self.setTransition(self.inner,"ease",adjust,{x:0,y:0});
					}
				}
				else if(self.wraper[sizeName]-relative_pos[self.direction]>self.inner[sizeName]){//企图加载更多 滑动超出了下方或者右侧尽头
					self.setTransition(self.inner,"ease",adjust,{x:0,y:self.wraper[sizeName]-self.inner[sizeName]});
				}
				else{//此处需要缓冲处理  中间态
					//缓冲运动

					
					var adjust=self.options.adjustTime;
					var slow_time=self.options.adjustTime.match(/\d+/)[0];
					var slow_distance=Math.round(slow_time*self.speed);//
					var dist=relative_pos[self.direction]+slow_distance;//x或者y方向
					var endDis=self.wraper[sizeName]-self.inner[sizeName];//滑动的终点差值
					var needBar=self.options.scrollBar;//是否需要滚动条
					if(!self.options.snap){
						if(self.speed>0){//正速度
							if(dist>=0){//头部尽头
								self.setTransition(self.inner,"slowdown",adjust,{x:0,y:0});
								needBar&&self.setTransition(self.bar,"slowdown",adjust,{x:0,y:0});
							}
							else{//往起始位置滑动
								var top=-dist*self.barSize/self.wraper[sizeName];
								self.setTransition(self.inner,"slowdown",adjust,{x:0,y:dist});
								needBar&&self.setTransition(self.bar,"slowdown",adjust,{x:0,y:top});
							}
							// self.options.snap&&self.next();
						}
						else{//负速度
							
							if(dist<endDis){
								var top=-endDis*self.barSize/self.wraper[sizeName];
								self.setTransition(self.inner,"slowdown",adjust,{x:0,y:endDis});
								needBar&&self.setTransition(self.bar,"slowdown",adjust,{x:0,y:top});
							}
							else{//往终点位置滑动
								var top=-dist*self.barSize/self.wraper[sizeName];
								self.setTransition(self.inner,"slowdown",adjust,{x:0,y:dist});
								needBar&&self.setTransition(self.bar,"slowdown",adjust,{x:0,y:top});

							}
							// self.options.snap&&self.prev();
						}
					}
					else{

						self.speed>0&&self.prev();
						self.speed<0&&self.next();
					}
					
					
				}

				
				console.log(self.speedX,slow_distance);
				self.options.touchend&&self.options.touchend.call(self,relative_pos);
			},
			getTransform:function(dom){
				var self=this;
				var transform=dom.style[prefixStyle("transform")];
				if(transform){
					var translateArray=( transform.replace(/translate3d|\(|\)|px/g,"") ).split(",");
					return {x:parseFloat(translateArray[0]),y:parseFloat(translateArray[1]),z:parseFloat(translateArray[2])};
				}
				else{
					dom.style[prefixStyle("transform")]="translate3d(0,0,0)";
					return {x:0,y:0,z:0}
				}
			},
			setTransform:function(dom,pos){
				var self=this;
				self.direction=="y"?pos.x=0:pos.y=0;
				dom.style[prefixStyle("transform")]="translate3d("+pos.x+"px,"+pos.y+"px,"+"0px)";
			},
			setTransition:function(dom,type,time,pos){
				var self=this;
				dom.style[prefixStyle("transitionTimingFunction")]=self.transType[type];
				dom.style[prefixStyle("transitionDuration")]=time;
				self.setTransform(dom,{x:pos.x,y:pos.y});

			},
			getClinetRect:function(dom){//当transform有值而且getBoundingClientRect不支持的话，offset是不准确的
				var self=this;
				if (!!dom.getBoundingClientRect) {
				  var rect = dom.getBoundingClientRect();
				  return {
				    x: rect.left,
				    y: rect.top,
				    width: rect.width,
				    height: rect.height
				  };
				} else {
				  return {
				    x: dom.offsetTop,
				    y: dom.offsetLeft,
				    width: dom.offsetWidth,
				    height: dom.offsetHeight
				  };
				}
			},
			getRelativePos:function(){
				var self=this;

				var wraper_client_pos=self.getClinetRect(self.wraper);
				var inner_client_pos=self.getClinetRect(self.inner);
				if(getComputedStyle){
					var borderTW=getComputedStyle(self.wraper)["border-top-width"].replace("px","")*1;
					var borderLW=getComputedStyle(self.wraper)["border-left-width"].replace("px","")*1;
				}
				else{
					var borderTW=0;
					var borderLW=0;
				}
				
				return {x:inner_client_pos.x-wraper_client_pos.x-borderTW,y:inner_client_pos.y-wraper_client_pos.y-borderLW};
			},
			tapType:function(trail,cancelTime){//点击类型   tap==>点击 move==>滑动 longtap==>长按 movestill==>滑动后静止
				var self=this;
				var stillTime=300;
				var durTime=cancelTime-trail[trail.length-1].time;
				if(trail.length==1){
					return durTime>stillTime?"longtap":"tap"
				}
				else{
					return durTime>300?"movestill":"move";
				}
			},
			moveDirection:function(){

			},
			getNearIndex:function(rel_pos){
				var self=this;
				var offset=rel_pos[self.direction];
				var index=0;
				if(offset>=0){
					index=0;
				}
				else{
					index=Math.round(-offset / self.innerItemSize);
				};
				self.snapIndex=index;
				return index;

			},
			goIndex:function(index){
				var self=this;
				var offset=-self.innerItemSize*index;
				self.setTransition(self.inner,"ease",self.options.snapTime||self.adjustTime,{
					x:self.direction=="x"?offset:0,
					y:self.direction=="y"?offset:0,
				});
			},
			next:function(){
				var self=this;
				var to=self.snapIndex+1;
				if(self.options.loop){
					if(to>self.snapNum){
						to=1;
					}
				}
				else{
					if(to>self.snapNum-1){
						to=0;
					}
				}
				self.goIndex(to);
			},
			prev:function(){
				var self=this;
				var to=self.snapIndex-1;
				if(to<0){
					to=0;
				}
				self.goIndex(to);
			},
			reloaded:function(){
				var self=this;
				console.log("loaded");
				self.refreshDom.innerHTML="加载完成!";
				setTimeout(function(){
					self.setTransition(self.inner,"ease",self.options.adjustTime,{x:0,y:0});
					self.setTransition(self.refreshDom,"ease",self.options.adjustTime,{x:0,y:-self.refreshDom.offsetHeight});
				},200);
				
				self.reloading=false;
			}
		};

		var wraper=document.getElementById("scrollWraper");

		scroller=new WYscroller(wraper,{
			startY:0,
			touchstart:function(pos){
				// console.log("start",pos);
			},
			touchmove:function(pos){
				// console.log("move",pos);
			},
			touchend:function(pos){
				// console.log("end",pos);
			},
			refreshEle:document.querySelector("#scrollWraper .refresh"),
			moreEle:document.querySelector("#scrollWraper .more"),
			scrollBar:true,
			reload:function(){
				var self=this;
				setTimeout(function(){
					console.log(213);
					self.reloaded();
				},2000);
			}
		});


		var swiperWraper=document.getElementById("swiperWraper");
		
		swiper=new WYscroller(swiperWraper,{
			scrollY:false,
			snap:true,
			startIndex:0,
			loop:true,//是否循环
			autoPlay:true,
		});



	</script>
</body>
</html>