<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" name="viewport">
	<meta content="yes" name="apple-mobile-web-app-capable">
	<meta content="black" name="apple-mobile-web-app-status-bar-style">
	<meta content="telephone=no" name="format-detection">
	<meta content="email=no" name="format-detection">
	<title>自定义缓冲滚动</title>

	<style>
		*{padding:0;margin:0;}
		body{background-color: #f8f8f8;min-height: 500px;padding-bottom: 300px;}
		#scrollWraper{width: 80%;margin:10px auto;border:1px solid #ccc;overflow: hidden;height: 300px;background-color: #fff;position: relative;}
		#scrollWraper #scrollContent{background-color: #fff;z-index:1;position: relative;}
		#scrollWraper .refresh{line-height: 40px;text-align: center;position: absolute;top:0;left:0;width: 100%;z-index:0;}
		#scrollWraper .more{line-height: 40px;text-align: center;position: absolute;bottom:0;left:0;width: 100%;z-index:0;}
		#scrollContent  li{line-height: 40px;text-align: center;border-top: 1px solid #f2f2f2;background-color: #fff;}
		dl{padding:10px;}
		dl dt{line-height: 30px;color:#f93;}
		dl dd{line-height: 20px;color:#666;font-size: 14px;}
	</style>
</head>
<body>
	<dl>
		<dt>实现功能</dt>
		<dd>1.滚动条</dd>
		<dd>2.上拉刷新</dd>
		<dd>3.下拉加载</dd>
		<dd>4.区块滚动 snap</dd>
		<dd>5.轮播图</dd>
		<dd>6.接口化，插件化，模块化</dd>
		<dd>7.惯性设置，边界超出设置</dd>
		<dd>8.拖动粘性</dd>
	</dl>
	<dl>
		<dt>技术难点</dt>
		<dd>1.缓冲运动</dd>
		<dd>2.边界问题</dd>
		<dd>3.刷新</dd>
		<dd>4.加载</dd>
		<dd>5.速度计算</dd>
		<dd>6.缓冲目标位就算</dd>
		<dd>7.动画结束回调</dd>
	</dl>
	<dl>
		<dt>注意</dt>
		<dd>1.可以模仿bscroller去做一些适配和兼容性</dd>
	</dl>
	<div id="scrollWraper">
		<ul id="scrollContent">
			<li>1</li>
			<li>2</li>
			<li>3</li>
			<li>4</li>
			<li>5</li>
			<li>6</li>
			<li>7</li>
			<li>8</li>
			<li>9</li>
			<li>10</li>
			<li>11</li>
			<li>12</li>
			<li>13</li>
			<li>14</li>
			<li>15</li>
			<li>16</li>
			<li>17</li>
			<li>18</li>
			<li>19</li>
			<li>20</li>
			<li>21</li>
			<li>22</li>
			<li>23</li>
			<li>24</li>
			<li>25</li>
			<li>26</li>
			<li>27</li>
			<li>28</li>
			<li>29</li>
			<li>30</li>
		</ul>
		<h4 class="refresh">下拉刷新</h4>
		<p class="more">加载更多</p>
	</div>


	<script>

		function extend(target,src){//对象扩展
			for(key in src){
				target[key]=src[key];
			}
		};

		var vendor = (function() {//浏览器供应商 获取浏览器前缀

			var elementStyle=document.createElement("div").style;
			var transformNames = {
			   webkit: 'webkitTransform',
			   Moz: 'MozTransform',
			   O: 'OTransform',
			   ms: 'msTransform',
			   standard: 'transform'
			};

			for (var key in transformNames) {
			   if (elementStyle[transformNames[key]] !== undefined) {
			      return key;
			   }
			}

			return false;
		})();

		var prefixStyle=function(style){//获取兼容各浏览器前缀样式
			if(vendor==false){
				return false;
			}
			if(vendor=="standard"){
				return style;
			}
			else{
				return vendor+style.charAt(0).toUpperCase()+style.substr(1);
			}
		};

		var caculateSpeed=function(arr){//[{x:x,y:y,time:timeStap}]

			var dur=arr[arr.length-1].time-arr[0].time;
			var dis_x=arr[arr.length-1].x-arr[0].x;
			var dis_y=arr[arr.length-1].y-arr[0].y;

			return {
				"speed-x":dis_x/dur,
				"speed-y":dis_y/dur
			}
		}



		function WYscroller(el,options){
			this.options={
				startX:0,
				startY:0,
				scrollY: true,//滚动方向
				snap:false,//是否分隔
				adjustTime:"400ms",//松手后自适应时间
				scrollBar:false,//是否需要滚动条
				touchstart:function(){},
				touchmove:function(){},
				touchend:function(){},
				reload:function(){},//在配置了下拉刷新的时候需要此配置项
				
			};
			this.transType={
				"ease":"cubic-bezier(.25,.1,.25,1)",
				"linear":"cubic-bezier(0,0,1,1)",
				"ease-in":"cubic-bezier(.42,0,1,1)",
				"ease-out":"cubic-bezier(0,0,.58,1)",
				"test":"cubic-bezier(.27,.08,.38,.97)",
				"slowdown":"cubic-bezier(.33,.47,.35,.91)"
			};
			extend(this.options,options);
			this.wraper=typeof el=="string"?document.queryselector(el):el;//外层元素
			this.inner=this.wraper.children[0];//包含的滚动元素
			this.refreshDom=this.options.refreshEle;
			this.moreDom=this.options.moreEle;
			var direction=this.direction=!this.options.scrollY?"x":"y";

			this.dragSlowLength=direction=="y"?this.wraper.offsetHeight*0.25:this.wraper.offsetWidth*0.25;//容器尺寸的4分之一
			this.reloading=false;//正在下拉重新加载

			
			
			this.init();//初始化
			console.log(this.options);
		}

		WYscroller.prototype={ 
			init:function(){
				var self=this;
				if(self.options.snap==false){
					self.initScroll();
					
				}
				else{

				}

				self.refreshDom&&self.initRefresh();
				self.moreDom&&self.initMore();
				self.options.scrollBar&&self.initScrollBar();

			},
			initScroll:function(){
				var self=this;
				var startX=self.options.startX+"px";
				var startY=self.options.startY+"px";

				//过渡函数 过渡时间 过渡终点位置
				self.setTransition(self.inner,"ease","0ms",{x:self.options.startX,y:self.options.startY});

				self.wraper.addEventListener("touchstart",self.startHandler.bind(self));
				self.wraper.addEventListener("touchmove",self.moveHandler.bind(self));
				self.wraper.addEventListener("touchend",self.endHandler.bind(self));

			},
			initRefresh:function(){
				var self=this;
				self.setTransition(self.refreshDom,"ease","0ms",{x:0,y:-self.refreshDom.offsetHeight});
			},
			initMore:function(){
				var self=this;
				self.setTransition(self.moreDom,"ease","0ms",{x:0,y:self.moreDom.offsetHeight});
			},
			initScrollBar:function(){
				var self=this;

				var innerH=self.inner.offsetHeight;
				var wraperH=self.wraper.offsetHeight;
				var scale=innerH / wraperH;
				var barSize=wraperH / scale;
				var innerIndex=window.getComputedStyle(self.inner).zIndex;
				var bar=self.bar=document.createElement("div");
				bar.style.display="block";
				bar.style.position="absolute";
				bar.style.top=0;
				bar.style.right=0;
				bar.style.width="4px";
				bar.style.height=barSize+"px";
				bar.style.backgroundColor="#e3e3e3";
				bar.style.zIndex=innerIndex+1;
				bar.style.borderRadius="2px";
				self.wraper.style.position="relative";

				self.barSize=barSize;
				self.wraper.appendChild(bar);
			},
			scrollBar:function(){
				var self=this;
				var innerH=self.inner.offsetHeight;
				var wraperH=self.wraper.offsetHeight;
				var scale=innerH / wraperH;
				var barSize=wraperH / scale;


			},
			startHandler:function(e){
				e.preventDefault();
				var self=this;
				var touch=e.touches[0];

				var click_finger_x=self.click_finger_x=touch.clientX;
				var click_finger_y=self.click_finger_y=touch.clientY;

				var relative_pos=self.click_relative_pos=self.getRelativePos();
				self.fingerArray=[];
				self.fingerArray.push({x:click_finger_x,y:click_finger_y,time:new Date()*1});

				self.setTransition(self.inner,"ease","0ms",{x:relative_pos.x,y:relative_pos.y});
				if(self.direction=="x"){

				}

				self.options.touchstart&&self.options.touchstart.call(self,relative_pos);//滚动监听
				console.log(touch,click_finger_x,click_finger_y,self.client_pos,relative_pos);
			},
			moveHandler:function(e){
				e.preventDefault();
				var self=this;
				var touch=e.touches[0];
				var move_finger_x=self.move_finger_x=touch.clientX;
				var move_finger_y=self.move_finger_y=touch.clientY;

				var length=2;
				if(self.fingerArray.length<length){
					self.fingerArray.push({x:move_finger_x,y:move_finger_y,time:new Date()*1});
				}
				else{
					self.fingerArray=self.fingerArray.slice(1);
					self.fingerArray.push({x:move_finger_x,y:move_finger_y,time:new Date()*1});
				}
				var speedX=self.speedX=caculateSpeed(self.fingerArray)["speed-x"];
				var speedY=self.speedY=caculateSpeed(self.fingerArray)["speed-y"];

				var relative_pos={
					x:self.move_finger_x-self.click_finger_x+self.click_relative_pos.x,
					y:self.move_finger_y-self.click_finger_y+self.click_relative_pos.y
				};

				//边界拖动抵抗
				var resistDistance=self.dragSlowLength;
				console.log(resistDistance);
				// if(relative_pos.y>resistDistance){
				// 	var deta=resistDistance/(relative_pos.y-resistDistance);
				// 	relative_pos.y=resistDistance+(relative_pos.y-resistDistance) * deta;


				// 	// console.log("draft");
				// 	// var deta=(relative_pos.y-resistDistance)/(resistDistance*resistDistance);
				// 	// relative_pos.y-=relative_pos.y*deta;
				// }

				self.setTransform(self.inner,relative_pos);



				if(self.refreshDom){
					if(relative_pos.y<=self.refreshDom.offsetHeight){
						self.setTransform(self.refreshDom,{x:relative_pos.x,y:relative_pos.y-self.refreshDom.offsetHeight});
					}
					else{
						self.setTransform(self.refreshDom,{x:relative_pos.x,y:0});
					}
				}
				
				if(self.options.scrollBar){//需要滚动条
					var top=-relative_pos.y*self.barSize/self.wraper.offsetHeight;
					self.setTransform(self.bar,{x:0,y:top});
				}

				self.options.touchmove&&self.options.touchmove.call(self,relative_pos);//滚动监听
				
				// console.log(self.fingerArray,speedX,speedY);
			},
			endHandler:function(e){
				e.preventDefault();
				var self=this;
				var relative_pos=self.getRelativePos();
				var adjust=self.options.adjustTime;

				//设置内容位置  
				if(relative_pos.y>0){//企图刷新
					if(relative_pos.y<self.refreshDom.offsetHeight){
						self.setTransition(self.inner,"test",adjust,{x:0,y:0});

						self.refreshDom&&self.setTransition(self.inner,"test",adjust,{x:0,y:self.refreshDom.offsetHeight});
					}
					else{//触发刷新动作

						if(self.refreshDom){//需要下拉刷新
							self.setTransition(self.inner,"test",adjust,{x:0,y:self.refreshDom.offsetHeight});
							
							!self.reloading&&self.options.reload&&self.options.reload.apply(self);//执行重新加载回调函数
							self.reloading=true;//正在加载
						}
						else{
							self.setTransition(self.inner,"test",adjust,{x:0,y:0});
						}
					}
				}
				else if(self.wraper.clientHeight-relative_pos.y>self.inner.clientHeight){
					self.setTransition(self.inner,"ease",adjust,{x:0,y:self.wraper.clientHeight-self.inner.clientHeight});
				}
				else{//此处需要缓冲处理
					//缓冲运动

					var adjust=self.options.adjustTime;
					var slow_time=self.options.adjustTime.match(/\d+/)[0];
					var slow_distance_y=Math.round(slow_time*self.speedY);//
					var dist_y=relative_pos.y+slow_distance_y;
					var needBar=self.options.scrollBar;//是否需要滚动条

					if(slow_distance_y>=0){//企图刷新
						if(dist_y>=0){
							self.setTransition(self.inner,"slowdown",adjust,{x:0,y:0});
							needBar&&self.setTransition(self.bar,"slowdown",adjust,{x:0,y:0});
						}
						else{
							var top=-dist_y*self.barSize/self.wraper.offsetHeight;
							self.setTransition(self.inner,"slowdown",adjust,{x:0,y:dist_y});
							needBar&&self.setTransition(self.bar,"slowdown",adjust,{x:0,y:top});
						}
					}
					else{//
						var bottomEndPos=self.wraper.offsetHeight-self.inner.offsetHeight;
						

						if(dist_y<bottomEndPos){
							var top=-bottomEndPos*self.barSize/self.wraper.offsetHeight;
							self.setTransition(self.inner,"slowdown",adjust,{x:0,y:bottomEndPos});
							needBar&&self.setTransition(self.bar,"slowdown",adjust,{x:0,y:top});
						}
						else{
							var top=-dist_y*self.barSize/self.wraper.offsetHeight;
							self.setTransition(self.inner,"slowdown",adjust,{x:0,y:dist_y});
							needBar&&self.setTransition(self.bar,"slowdown",adjust,{x:0,y:top});
						}
					}
					
				}

				

				console.log(self.speedX,slow_distance_y);
				self.options.touchend&&self.options.touchend.call(self,relative_pos);
			},
			getTransform:function(dom){
				var self=this;
				var transform=dom.style[prefixStyle("transform")];
				if(transform){
					var translateArray=( transform.replace(/translate3d|\(|\)|px/g,"") ).split(",");
					return {x:parseFloat(translateArray[0]),y:parseFloat(translateArray[1]),z:parseFloat(translateArray[2])};
				}
				else{
					dom.style[prefixStyle("transform")]="translate3d(0,0,0)";
					return {x:0,y:0,z:0}
				}
			},
			setTransform:function(dom,pos){
				var self=this;
				if(self.direction=="y"){
					pos.x=0;
				}
				else{
					pos.y=0;
				}
				dom.style[prefixStyle("transform")]="translate3d("+pos.x+"px,"+pos.y+"px,"+"0px)";
			},
			setTransition:function(dom,type,time,pos){
				var self=this;
				dom.style[prefixStyle("transitionTimingFunction")]=self.transType[type];
				dom.style[prefixStyle("transitionDuration")]=time;
				self.setTransform(dom,{x:pos.x,y:pos.y});

			},
			getClinetRect:function(dom){//当transform有值而且getBoundingClientRect不支持的话，offset是不准确的
				var self=this;
				if (!!dom.getBoundingClientRect) {
				  var rect = dom.getBoundingClientRect();
				  return {
				    x: rect.left,
				    y: rect.top,
				    width: rect.width,
				    height: rect.height
				  };
				} else {
				  return {
				    x: dom.offsetTop,
				    y: dom.offsetLeft,
				    width: dom.offsetWidth,
				    height: dom.offsetHeight
				  };
				}
			},
			getRelativePos:function(){
				var self=this;

				var wraper_client_pos=self.getClinetRect(self.wraper);
				var inner_client_pos=self.getClinetRect(self.inner);
				if(getComputedStyle){
					var borderTW=getComputedStyle(self.wraper)["border-top-width"].replace("px","")*1;
					var borderLW=getComputedStyle(self.wraper)["border-left-width"].replace("px","")*1;
				}
				else{
					var borderTW=0;
					var borderLW=0;
				}
				
				return {x:inner_client_pos.x-wraper_client_pos.x-borderTW,y:inner_client_pos.y-wraper_client_pos.y-borderLW};
			},
			reloaded:function(){
				var self=this;
				console.log("loaded");
				self.setTransition(self.inner,"ease",self.options.adjustTime,{x:0,y:0});
				self.setTransition(self.refreshDom,"ease",self.options.adjustTime,{x:0,y:-self.refreshDom.offsetHeight});
				self.reloading=false;
			}
		};

		var wraper=document.getElementById("scrollWraper");
		scroller=new WYscroller(wraper,{
			startY:0,
			touchstart:function(pos){
				console.log("start",pos);
			},
			touchmove:function(pos){
				// console.log("move",pos);
			},
			touchend:function(pos){
				console.log("end",pos);
			},
			refreshEle:document.querySelector("#scrollWraper .refresh"),
			moreEle:document.querySelector("#scrollWraper .more"),
			scrollBar:true,
			reload:function(){
				var self=this;
				setTimeout(function(){
					console.log(213);
					self.reloaded();
				},2000);
			}
		});













		//window.onload=loaded();
		function loaded(){
			var wraper=document.getElementById("scrollWraper");
			var inner=document.getElementById("scrollContent");

			wraper.addEventListener("touchstart",startHandler);
			wraper.addEventListener("touchmove",moveHandler);
			wraper.addEventListener("touchend",endHandler);

			var startPos;
			var startTranslate;
			var lastMovePos;
			var lastMoveTime;
			var speed=0;
			var resistDistance=80;

			function startHandler(e){
				var touch=e.touches[0];
				var start_x=touch.clientX;
				var start_y=touch.clientY;
				speed=0;
				startPos={x:start_x,y:start_y};
				lastMovePos=startPos;
				lastMoveTime=new Date()*1;
				
				try{
					if(slowDownTimer){
						clearInterval(slowDownTimer);
					}
					if(animateTransformTimer){
						clearInterval(animateTransformTimer);
					}
				}
				catch(e){

				}
				
			}

			function moveHandler(e){
				e.preventDefault();
				var touch=e.touches[0];
				var move_x=touch.clientX;
				var move_y=touch.clientY;
				var move_time=new Date()*1;
				var dis_y=move_y-lastMovePos.y;
				var dur_time=move_time-lastMoveTime;
				var translate=getTransform(inner);
				if(translate.y>0&&translate.y<=resistDistance){//顶部露出
					var deta=(resistDistance-translate.y)/resistDistance;
					translate.y+=dis_y * deta;
				}
				// else if(translate.y<0 && (inner.offsetHeight<=wraper.offsetHeight-translate.y<=inner.offsetHeight+resistDistance) ){
				// 	var deta=(wraper.offsetHeight-translate.y-inner.offsetHeight-resistDistance)/resistDistance;
				// 	translate.y+=dis_y * deta;
				// }
				else{
					translate.y+=dis_y;
				}
				
				setTransform(inner,translate);

				lastMovePos={x:move_x,y:move_y};
				lastMoveTime=move_time;
				speed=(dis_y / dur_time).toFixed(2);
				console.log(speed,translate);
			}

			function endHandler(e){

				
				var translate=getTransform(inner);
				console.log(speed,-translate.y+wraper.clientHeight,inner.clientHeight);
				if(translate.y > 0){//顶部露出
					animateTransform(inner,{x:0,y:0,z:0})
				}
				else if(-translate.y+wraper.clientHeight>inner.clientHeight){
					console.log("bottom");
					animateTransform(inner,{x:0,y:0,z:0});
				}
				else{
					
					slowDown(inner);
				}
				
			}



			function getTransform(dom){
				var transform=dom.style.webkitTransform;
				if(transform){
					var translateArray=( transform.replace(/translate3d|\(|\)|px/g,"") ).split(",");
					return {x:parseFloat(translateArray[0]),y:parseFloat(translateArray[1]),z:parseFloat(translateArray[2])};
				}
				else{
					dom.style.webkitTransform="translate3d(0,0,0)";
					return {x:0,y:0,z:0}
				}
				
			}

			function setTransform(dom,translate){
				var tranStr="translate3d("+translate.x+"px,"+translate.y+"px,"+translate.z+"px)";
				
				dom.style.webkitTransform=tranStr;
			}

			function slowDown(dom){
				
				
				var intervalDur=5;
				slowDownTimer=setInterval(slow,intervalDur);
				
				function slow(){
					var deta=0.95;
					speed=speed * deta;
					var translate=getTransform(dom);
					var dis_y=speed * intervalDur * deta;
					// console.log(speed,dis_y);
					if(Math.abs(dis_y)<=0.00001){//速度足够小  终止运动
						clearInterval(slowDownTimer);
					}
					else{

						if(translate.y>0){
							var deta=(resistDistance-translate.y)/resistDistance;
							translate.y+=dis_y * deta;
							// console.log(dis_y,translate);
						}
						else{
							translate.y+=dis_y;
							// console.log("slow",dis_y,translate);

						}
						
						setTransform(dom,translate)
					}
				}
			}


			function animateTransform(dom,translateEnd){
				

				animateTransformTimer=setInterval(animate,5);

				function animate(){
					var translate=getTransform(dom);
					var dis=translateEnd.y-translate.y;

					var speed=dis * 0.03;
					if(translate.y>=0.4){
						translate.y+=speed;
						setTransform(dom,translate);
					}
					else{
						clearInterval(animateTransformTimer);
					}
					
				}
			}
		}

		

	</script>
</body>
</html>