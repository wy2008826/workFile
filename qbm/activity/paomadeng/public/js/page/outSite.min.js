define(function(require,exports,module){require("zepto"),require("fastclick");var template=require("artTemplate");FastClick.attach(document.body);var Slot=function(_config){var config={durTime:6e3,allComplateCallBack:function(){console.log("end")}};this.config=$.extend(config,_config),console.log(config),this.isAnimating=!1};Slot.prototype={init:function(){},getNextIndex:function(curIndex){var self=this,itemL=self.config.slotItems.length;return itemL-1>curIndex?curIndex+1:curIndex==itemL-1?0:void 0},getCountNum:function(startInd,endInd){var self=this;self.config.slotItems.length;return 6*self.config.slotItems.length+1-(5-(endInd-startInd))},startAnimate:function(startInd,endInd,allComplateCallBack){function animateItem(index,callBack){$(".cards_item.active").removeClass("active"),self.config.slotItems[index].addClass("active"),callBack&&setTimeout(function(){callBack(),self.isAnimating=!1},400)}var self=this,countNum=self.getCountNum(startInd,endInd);self.config.slotItems[startInd].addClass("active");var durTime=50,count=0;self.isAnimating=!0;var timer=setInterval(function(){function callTimeout(time,callBack){setTimeout(function(){animateItem(startInd,callBack),startInd=self.getNextIndex(startInd)},time)}if(animateItem(startInd),startInd=self.getNextIndex(startInd),count+=1,count>=countNum){clearInterval(timer);var base=1.7;callTimeout(durTime*Math.pow(base,2.5)),callTimeout(durTime*Math.pow(base,3.5)),callTimeout(durTime*Math.pow(base,4.5)),callTimeout(durTime*Math.pow(base,5.5)),callTimeout(durTime*Math.pow(base,6.5),allComplateCallBack)}},durTime)},setSlotAnimation:function(start,end,allComplateCallBack){var self=this;self.isAnimating||self.startAnimate(start,end,allComplateCallBack)},getAnimateState:function(){return this.isAnimating}},$(function(){var App=function(){this.tpl={alertMsgTpl:template.compile($("#normalMsg").html()),wishNoPhoneTpl:template.compile($("#wishNoPhoneTpl").html()),wishHasPhoneTpl:template.compile($("#wishHasPhoneTpl").html()),changePhoneTpl:template.compile($("#changePhoneTpl").html())},this.url={webUrl:$("#webUrl").val(),slotUrl:"/slot.html",wishPeopleUrl:"/wishes.html",changePhoneUrl:"/changePhone.html",getCountNumUrl:"/getCountNum.html"},this.formatPhone=function(phone){return phone.substr(0,3)+"****"+phone.substr(7,11)},this.layerTip=function(text){layer.open({content:"<p>"+text+"</p>",className:"layer-tip",time:2,shadeClose:!1})},this.setCountNum=function(num){var $count_num=$("#count_num"),$count_btn=$("#start_item");num>0?($count_num.text(num+"次"),$count_btn.removeClass("disabled")):($count_num.text(""),$count_btn.addClass("disabled"))},this.getAndSetCountNum=function(){var self=this,url=self.url.webUrl+self.url.getCountNumUrl,param={userId:"123213",mark:"123"};$.ajax({type:"get",url:url,data:param,dataType:"jsonp",success:function(data){var num=Math.round(100*Math.random());self.setCountNum(num)},error:function(){console.log("error");var num=Math.round(100*Math.random());self.setCountNum(num)}})},this.setWishNumAndText=function(num){var num=Math.round(100*Math.random());$("#wishes_num").text(num);var html="aaa祝福bbb<label>哈哈哈哈哈哈哈的完全后期维护完</label>";$("#mes_inner").html(html)},this.setMarqune=function(){function Marquee(){"left"==direction?wraper.scrollLeft>=inner.offsetWidth-wraper.offsetWidth-2?direction="right":wraper.scrollLeft++:"right"==direction&&(wraper.scrollLeft<=0?direction="left":wraper.scrollLeft--)}var speed=30,inner=document.getElementById("mes_inner"),wraper=document.getElementById("mes_wraper"),direction="left";setInterval(Marquee,speed)},this.init(),this.setMarqune(),this.timeOut(),$(".fixed_reg").length<=0?this.setCountNum(0):(this.getAndSetCountNum(),this.clickGoHandler(),this.wishPeople(),this.changePhone())};App.prototype={init:function(){$("body").on("click",".layermchild .alert_btn",function(){var $btn=$(this),href=$btn.attr("data-href");href&&(window.location.href=href),$btn.hasClass("clickClose")&&layer.closeAll()})},timeOut:function(){var self=this,endTime=1460539200,now=$("#serverTime").val()||1460539199;if(now>=endTime){var html=self.tpl.alertMsgTpl({normalMsg:[{text:"<p class='alert_mes'>活动已经结束，下次再来表白</p>"}],btnText:"下次再试试"});layer.open({content:html,shadeClose:!1})}},clickGoHandler:function(){for(var self=this,slotArr=[],slotL=8,i=0;slotL>i;i++){var id="slot"+i;slotArr.push($("#"+id))}var slot=new Slot({slotItems:slotArr}),isGetting=!1;$("#start_item").on("click",function(){function successAnimate(data){if(0!=$(".cards_item.active").length)var startIndex=1*$(".cards_item.active").attr("id").replace("slot","");else var startIndex=Math.round(Math.random()*(slotL-1));var endIndex=Math.round(Math.random()*(slotL-1));console.log(startIndex,endIndex),slot.setSlotAnimation(startIndex,endIndex,allComplateCallBack.bind(self,data))}function allComplateCallBack(data){var self=this;console.log(data);var prize=data.prize||"10元投资话费",tplData={normalMsg:[{text:"<p class='alert_mes'>恭喜您获得"+prize+"</p>"}],dirUrl:"https://www.baidu.com"},html=self.tpl.alertMsgTpl(tplData);layer.open({content:html}),self.setCountNum(11)}var $btn=$(this),isAnimating=slot.getAnimateState();if($btn.hasClass("disabled")||isAnimating||isGetting)return!1;$btn.addClass("active"),setTimeout(function(){$btn.removeClass("active")},50),isGetting=!0;var url=self.url.webUrl+self.url.slotUrl,url="http://wap.qbm360.com/api/getBorrowList.html",param={currentPage:1,pernum:10};$.ajax({url:url,type:"get",dataType:"jsonp",data:param,success:function(data){isGetting=!1,console.log("success"),alert(JSON.stringify(data)),successAnimate(data)},error:function(e){isGetting=!1,console.log("error"),successAnimate(data)}})})},wishPeople:function(){var self=this;$("#wishPeople").on("click",function(){if("-1"==$("#wish_text").text().trim().search(/\d/))return!1;var $phone_mes=$("#phone_mes"),hasPhone=!$phone_mes.hasClass("hide")&&$phone_mes.length>0;if(hasPhone)var html=self.tpl.wishHasPhoneTpl({});else var html=self.tpl.wishNoPhoneTpl({});layer.open({content:html})}),$("body").on("click","#alert_wish_btn",function(){function wishSuccess(data){self.setCountNum(123),layer.closeAll(),$("#phone_mes").removeClass("hide"),$("#pagePhone").attr("data-phone",param.myPhone).text(self.formatPhone(param.myPhone));var alertData={normalMsg:[{text:"<p class='alert_mes'>恭喜您获得<span class='fc-red'>一次</span>开跑机会</p><p class='alert_mes'>快去使用吧</p><p class='alert_mes'>注册后还有更多机会哦</p>"}]},html=self.tpl.alertMsgTpl(alertData);layer.open({content:html,success:function(){var htmlH=$("html").height();$(".layermbox").css("height",htmlH)}}),self.setWishNumAndText()}var $phone_mes=$("#phone_mes"),$alert_phone=$(".layermcont .alert_phone"),$alert_wish=$(".layermcont .alert_wish"),$alert_error=$(".layermcont .alert_error"),phoneVal=$alert_phone.val(),wishVal=$alert_wish.val(),regu=/^1[3578]\d{9}$/;!$phone_mes.hasClass("hide");if($alert_phone.length>0){if(""==phoneVal||null==phoneVal)return $alert_error.removeClass("hide").text("手机号码不能为空"),!1;if(!regu.test(phoneVal)||11!=phoneVal.length)return $alert_error.removeClass("hide").text("请输入正确的手机号码"),!1}if(""==wishVal||null==wishVal)return $alert_error.removeClass("hide").text("祝福语不能为空"),!1;if(wishVal.length>40)return $alert_error.removeClass("hide").text("祝福语不能超过40个字符"),!1;$alert_error.addClass("hide").text("");var param={wishText:$alert_wish.val().trim(),otherPhone:$("#refer_phone").val().trim()};$alert_phone.length>0?(param.myPhone=$alert_phone.eq(0).val().trim(),param.mark=1):(param.myPhone=$("#pagePhone").attr("data-phone").trim(),param.mark=0);var url=self.url.webUrl+self.url.wishPeopleUrl;console.log(param,url),$.ajax({type:"get",url:url,data:param,dataType:"jsonp",success:function(data){alert(JSON.stringify(data)),wishSuccess(data)},error:function(){wishSuccess(),console.log("error")}})})},changePhone:function(){var self=this;$("#changePhone").on("click",function(){var curPhone=$("#pagePhone").attr("data-phone").trim(),html=self.tpl.changePhoneTpl({curPhone:curPhone});layer.open({content:html,success:function(){function validateChangePhone(){var regu=/^1[3578]\d{9}$/,$phoneInp=$(".layermchild .alert_change_phone").eq(0);console.log("validate"),regu.test($phoneInp.val().trim())?$submitBtn.removeClass("disabled"):$submitBtn.addClass("disabled")}var htmlH=$("html").height();$(".layermbox").css("height",htmlH);var $submitBtn=$(".layermchild #alert_change_btn").eq(0);$(".layermchild .alert_change_phone").on("input",function(){$(this);validateChangePhone()})}})}),$("body").on("click",".layermchild #alert_change_btn",function(){function changeSuccess(){self.layerTip("错误")}var $btn=$(this);if($btn.hasClass("disabled"))return!1;var url=self.url.webUrl+self.url.changePhoneUrl,param={oldPhone:$("#pagePhone").attr("data-phone").trim(),newPhone:$(".layermchild .alert_change_phone").eq(0).val().trim()};$.ajax({type:"get",url:url,dataType:"jsonp",data:param,success:function(data){alert(JSON.stringify(data)),changeSuccess(data)},error:function(){changeSuccess()}})})}};new App})});