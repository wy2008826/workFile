define(function(require,exports,module){require("zepto"),require("fastclick"),require("swiper");var template=require("artTemplate");FastClick.attach(document.body);var Slot=function(_config){var config={durTime:6e3,allComplateCallBack:function(){console.log("end")}};this.config=$.extend(config,_config),console.log(config),this.isAnimating=!1};Slot.prototype={init:function(){},getNextIndex:function(curIndex){var self=this,itemL=self.config.slotItems.length;return itemL-1>curIndex?curIndex+1:curIndex==itemL-1?0:void 0},getCountNum:function(startInd,endInd){var self=this;self.config.slotItems.length;return 6*self.config.slotItems.length+1-(5-(endInd-startInd))},startAnimate:function(startInd,endInd,allComplateCallBack){function animateItem(index,callBack){$(".cards_item.active").removeClass("active"),self.config.slotItems[index].addClass("active"),callBack&&setTimeout(function(){callBack(),self.isAnimating=!1},400)}var self=this,countNum=self.getCountNum(startInd,endInd);self.config.slotItems[startInd].addClass("active");var durTime=50,count=0;self.isAnimating=!0;var timer=setInterval(function(){function callTimeout(time,callBack){setTimeout(function(){animateItem(startInd,callBack),startInd=self.getNextIndex(startInd)},time)}if(animateItem(startInd),startInd=self.getNextIndex(startInd),count+=1,count>=countNum){clearInterval(timer);var base=1.7;callTimeout(durTime*Math.pow(base,2.5)),callTimeout(durTime*Math.pow(base,3.5)),callTimeout(durTime*Math.pow(base,4.5)),callTimeout(durTime*Math.pow(base,5.5)),callTimeout(durTime*Math.pow(base,6.5),allComplateCallBack)}},durTime)},setSlotAnimation:function(start,end,allComplateCallBack){var self=this;self.isAnimating||self.startAnimate(start,end,allComplateCallBack)},getAnimateState:function(){return this.isAnimating}},$(function(){var App=function(){this.tpl={alertMsgTpl:template.compile($("#normalMsg").html()),wishesTpl:template.compile($("#wishes_tpl").html()),awardsTpl:template.compile($("#awards_tpl").html())},this.url={webUrl:$("#webUrl").val(),slotUrl:"/slot.html",awardsUrl:"/awards.html",wishesUrl:"/wishes.html"},this.setCountNum=function(num){var $count_num=$("#count_num"),$count_btn=$("#start_item");num>0?($count_num.text(num+"次"),$count_btn.removeClass("disabled")):($count_num.text(""),$count_btn.addClass("disabled"))},this.setWishNumAndText=function(num){var num=Math.round(100*Math.random());$("#wishes_num").text(num);var html="aaa祝福bbb<label>哈哈哈哈哈哈哈的完全后期维护完</label>";$("#mes_inner").html(html)},this.setMarqune=function(){function Marquee(){"left"==direction?wraper.scrollLeft>=inner.offsetWidth-wraper.offsetWidth-2?direction="right":wraper.scrollLeft++:"right"==direction&&(wraper.scrollLeft<=0?direction="left":wraper.scrollLeft--)}var speed=30,inner=document.getElementById("mes_inner"),wraper=document.getElementById("mes_wraper"),direction="left";setInterval(Marquee,speed)},this.updateWishesLists=function(){function getAndAppendWishesLists(page){function callBack(data){var listsL=data.lists.length;if(1==page){if(0==listsL)$("#wishes_pagination").addClass("hide"),$(".wishes_lists_wraper .no_data_lists").removeClass("hide");else if(listsL>0){6>listsL?$("#wishes_pagination").addClass("hide"):$("#wishes_pagination").removeClass("hide");var html=self.tpl.wishesTpl(data);self.wishesSwiper.appendSlide(html),self.wishesSwiper.slideTo(page)}}else if(page>1){if(0==listsL)return hasGetAll=!0,!1;if(6>listsL){hasGetAll=!0;var html=self.tpl.wishesTpl(data);self.wishesSwiper.appendSlide(html),self.wishesSwiper.slideNext()}else{var html=self.tpl.wishesTpl(data);self.wishesSwiper.appendSlide(html),self.wishesSwiper.slideNext()}}}console.log("getting:"+page);var url=self.url.webUrl+self.url.wishesUrl,param={page:page,count:6};alert(JSON.stringify(param)),$.ajax({type:"get",url:url,data:param,dataType:"jsonp",success:function(dt){var data={lists:dt};alert(JSON.stringify(data)),callBack(data)},error:function(){var data=pagesData["data"+page];callBack(data)}})}console.log("updatingWishes");var self=this,$wishes_swiper_page=$("#wishes_swiper_page");self.wishesSwiper&&(console.log(self.wishesSwiper),self.wishesSwiper.destroy(),$("#wishes_lists_container .swiper-wrapper").html(""),$wishes_swiper_page.text("1"));var activeIndex=1,hasGetAll=!1;self.wishesSwiper=new Swiper("#wishes_lists_container",{autoplay:!1,loop:!1,swipeHandler:".aaaa",onSlideChangeEnd:function(){activeIndex=self.wishesSwiper.activeIndex+1,$wishes_swiper_page.text(activeIndex)}});var pagesData={data1:{lists:[{nickName:"习大大1",addTime:"2015-12-21 22:30:30",intro:"恭喜您获得一个驴打滚",imgSrc:"http://10.10.14.220:8080/zajk/statics/images/activity/2016/paomadeng/slot_1.png"},{nickName:"习大大1",addTime:"2015-12-21 22:30:30",intro:"恭喜您获得一个驴打滚",imgSrc:"http://10.10.14.220:8080/zajk/statics/images/activity/2016/paomadeng/slot_1.png"},{nickName:"习大大1",addTime:"2015-12-21 22:30:30",intro:"恭喜您获得一个驴打滚",imgSrc:"http://10.10.14.220:8080/zajk/statics/images/activity/2016/paomadeng/slot_1.png"},{nickName:"习大大1",addTime:"2015-12-21 22:30:30",intro:"恭喜您获得一个驴打滚",imgSrc:"http://10.10.14.220:8080/zajk/statics/images/activity/2016/paomadeng/slot_1.png"},{nickName:"习大大1",addTime:"2015-12-21 22:30:30",intro:"恭喜您获得一个驴打滚",imgSrc:"http://10.10.14.220:8080/zajk/statics/images/activity/2016/paomadeng/slot_1.png"},{nickName:"习大大1",addTime:"2015-12-21 22:30:30",intro:"恭喜您获得一个驴打滚",imgSrc:"http://10.10.14.220:8080/zajk/statics/images/activity/2016/paomadeng/slot_1.png"}]},data2:{lists:[{nickName:"习大大1",addTime:"2015-12-21 22:30:30",intro:"恭喜您获得一个驴打滚",imgSrc:"http://10.10.14.220:8080/zajk/statics/images/activity/2016/paomadeng/slot_1.png"},{nickName:"习大大1",addTime:"2015-12-21 22:30:30",intro:"恭喜您获得一个驴打滚",imgSrc:"http://10.10.14.220:8080/zajk/statics/images/activity/2016/paomadeng/slot_1.png"},{nickName:"习大大1",addTime:"2015-12-21 22:30:30",intro:"恭喜您获得一个驴打滚",imgSrc:"http://10.10.14.220:8080/zajk/statics/images/activity/2016/paomadeng/slot_1.png"},{nickName:"习大大1",addTime:"2015-12-21 22:30:30",intro:"恭喜您获得一个驴打滚",imgSrc:"http://10.10.14.220:8080/zajk/statics/images/activity/2016/paomadeng/slot_1.png"},{nickName:"习大大1",addTime:"2015-12-21 22:30:30",intro:"恭喜您获得一个驴打滚",imgSrc:"http://10.10.14.220:8080/zajk/statics/images/activity/2016/paomadeng/slot_1.png"},{nickName:"习大大1",addTime:"2015-12-21 22:30:30",intro:"恭喜您获得一个驴打滚",imgSrc:"http://10.10.14.220:8080/zajk/statics/images/activity/2016/paomadeng/slot_1.png"}]},data3:{lists:[{nickName:"习大大1",addTime:"2015-12-21 22:30:30"},{nickName:"习大大1",addTime:"2015-12-21 22:30:30"},{nickName:"习大大1",addTime:"2015-12-21 22:30:30"},{nickName:"习大大1",addTime:"2015-12-21 22:30:30"}]}};getAndAppendWishesLists(1);var $prev=$("#wishes_pagination .swiper_prev"),$next=$("#wishes_pagination .swiper_next");$prev.unbind("click"),$next.unbind("click"),$prev.on("click",function(){self.wishesSwiper.slidePrev()}),$next.on("click",function(){if(self.wishesSwiper.animating)return!1;var slidesAcount=self.wishesSwiper.slides.length;if(console.log(activeIndex,slidesAcount),slidesAcount>activeIndex)self.wishesSwiper.slideNext();else if(activeIndex==slidesAcount){if(hasGetAll)return!1;getAndAppendWishesLists(activeIndex+1)}})},this.updateCoutAndAwardsLists=function(){function getAndAppendAwardLists(page){function callBack(data){var listsL=data.lists.length;if(1==page){if(0==listsL)$("#award_pagination").addClass("hide"),$(".award_lists_wraper .no_data_lists").removeClass("hide");else if(listsL>0){6>listsL?$("#award_pagination").addClass("hide"):$("#award_pagination").removeClass("hide");var html=self.tpl.awardsTpl(data);self.awardsSwiper.appendSlide(html),self.awardsSwiper.slideTo(page)}}else if(page>1){if(0==listsL)return hasGetAll=!0,!1;if(6>listsL){hasGetAll=!0;var html=self.tpl.awardsTpl(data);self.awardsSwiper.appendSlide(html),self.awardsSwiper.slideNext()}else{var html=self.tpl.awardsTpl(data);self.awardsSwiper.appendSlide(html),self.awardsSwiper.slideNext()}}var count=Math.round(100*Math.random());self.setCountNum(count)}console.log("getting:"+page);var url=self.url.webUrl+self.url.awardsUrl,param={page:page,count:6};alert(JSON.stringify(param)),$.ajax({type:"get",url:url,data:param,dataType:"jsonp",success:function(dt){var data={lists:dt};alert(JSON.stringify(data)),callBack(data)},error:function(){var data=pagesData["data"+page];callBack(data)}})}console.log("updatingAwards");var self=this,$award_swiper_page=$("#award_swiper_page");self.awardsSwiper&&(console.log(self.awardsSwiper),self.awardsSwiper.destroy(),$("#award_lists_container .swiper-wrapper").html(""),$award_swiper_page.text("1"));var activeIndex=1,hasGetAll=!1;self.awardsSwiper=new Swiper("#award_lists_container",{autoplay:!1,loop:!1,swipeHandler:".aaaa",onSlideChangeEnd:function(){activeIndex=self.awardsSwiper.activeIndex+1,$award_swiper_page.text(activeIndex)}});var pagesData={data1:{lists:[{prize:"10元话费1",addTime:"2015-12-21 22:30:30"},{prize:"电影票一张1",addTime:"2015-12-21 22:30:30"},{prize:"豪华双人游1",addTime:"2015-12-21 22:30:30"},{prize:"10元话费1",addTime:"2015-12-21 22:30:30"},{prize:"10元红1",addTime:"2015-12-21 22:30:30"},{prize:"10元话费1",addTime:"2015-12-21 22:30:30"}]},data2:{lists:[{prize:"10元话费2",addTime:"2015-12-21 22:30:30"},{prize:"电影票一张2",addTime:"2015-12-21 22:30:30"},{prize:"豪华双人游2",addTime:"2015-12-21 22:30:30"},{prize:"10元话费2",addTime:"2015-12-21 22:30:30"},{prize:"10元红2",addTime:"2015-12-21 22:30:30"},{prize:"10元话费2",addTime:"2015-12-21 22:30:30"}]},data3:{lists:[{prize:"10元话费3",addTime:"2015-12-21 22:30:30"},{prize:"电影票一张3",addTime:"2015-12-21 22:30:30"},{prize:"豪华双人游3",addTime:"2015-12-21 22:30:30"},{prize:"10元话费3",addTime:"2015-12-21 22:30:30"}]}};getAndAppendAwardLists(1),$("#award_pagination .swiper_prev").unbind("click"),$("#award_pagination .swiper_next").unbind("click"),$("#award_pagination .swiper_prev").on("click",function(){self.awardsSwiper.slidePrev()}),$("#award_pagination .swiper_next").on("click",function(){if(self.awardsSwiper.animating)return!1;var slidesAcount=self.awardsSwiper.slides.length;if(console.log(activeIndex,slidesAcount),slidesAcount>activeIndex)self.awardsSwiper.slideNext();else if(activeIndex==slidesAcount){if(hasGetAll)return!1;getAndAppendAwardLists(activeIndex+1)}})},this.init(),this.setMarqune(),this.timeOut(),this.updateCoutAndAwardsLists(),this.updateWishesLists(),this.clickGoHandler()};App.prototype={init:function(){$("body").on("click",".layermchild .alert_btn",function(){var $btn=$(this),href=$btn.attr("data-href");layer.closeAll(),""!=href&&(window.location.href=href)})},timeOut:function(){var self=this,endTime=1460539200,now=$("#serverTime").val()||1460539199;if(now>=endTime){var html=self.tpl.alertMsgTpl({normalMsg:[{text:"<p class='alert_mes'>活动已经结束，下次再来表白</p>"}],btnText:"下次再试试"});layer.open({content:html,shadeClose:!1})}},clickGoHandler:function(){for(var self=this,slotArr=[],slotL=8,i=0;slotL>i;i++){var id="slot"+i;slotArr.push($("#"+id))}var slot=new Slot({slotItems:slotArr}),isGetting=!1;$("#start_item").on("click",function(){function successAnimate(data){if(0!=$(".cards_item.active").length)var startIndex=1*$(".cards_item.active").attr("id").replace("slot","");else var startIndex=Math.round(Math.random()*(slotL-1));var endIndex=Math.round(Math.random()*(slotL-1));console.log(startIndex,endIndex),slot.setSlotAnimation(startIndex,endIndex,allComplateCallBack.bind(self,data))}function allComplateCallBack(data){console.log(this);var self=this;console.log(data);var prize=data.prize||"10元投资话费",tplData={normalMsg:[{text:"<p class='alert_mes'>恭喜您获得"+prize+"</p>"}],dirUrl:"https://www.baidu.com"},html=self.tpl.alertMsgTpl(tplData);layer.open({content:html}),self.updateCoutAndAwardsLists()}var $btn=$(this),isAnimating=slot.getAnimateState();if($btn.hasClass("disabled")||isAnimating||isGetting)return!1;$btn.addClass("active"),setTimeout(function(){$btn.removeClass("active")},50),isGetting=!0;var url=self.url.webUrl+self.url.slotUrl,url="http://wap.qbm360.com/api/getBorrowList.html",param={currentPage:1,pernum:10};$.ajax({url:url,type:"get",dataType:"jsonp",data:param,success:function(data){isGetting=!1,console.log("success"),successAnimate(data)},error:function(e){isGetting=!1,console.log("error"),successAnimate()}})})}};new App})});