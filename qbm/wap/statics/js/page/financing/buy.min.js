define(function(require,exports,module){require("zepto"),require("fastclick"),FastClick.attach(document.body),template=require("artTemplate"),template.helper("selectedClass",function(status){return 1==status?"active":""}),template.helper("timeLeft",function(time){var now=new Date,expried=new Date(time),seconds=1*expried-1*now,days=Math.ceil(seconds/864e5);return days+1}),$(function(){var App=function(){this.url={wapUrl:$("#wapurl").val(),buyBorrow:"/api/member/tender.html",packetList:"/api/member/getRedPacketList.html"},this.getParam=function(key){for(var href=window.location.href,index=href.indexOf("?"),hashArr=href.substr(index+1).split("?")[0].split("&"),i=0;i<hashArr.length;i++){var group=hashArr[i].split("=");if(group[0]==key)return group[1]}},this.alertMes=function(html){layer.open({content:html,shadeClose:!1,type:1,className:"hasPadding",btn:["好的"]})},this.tipAlert=function(html){layer.open({content:html,className:"layer-tip",time:2,shadeClose:!1})},this.borrow_id=this.getParam("borrow_id"),this.borrowTimeLimit=1*$("#borrowTimeLimit").val().trim(),this.calRate=function(redVal,buyAcount){var raise=365*redVal*100/(buyAcount*this.borrowTimeLimit)+"",dotIndex=raise.indexOf("."),hasDot=dotIndex>0;return hasDot?raise.substr(0,dotIndex+3)+"%":raise+"%"},this.isIos=function(){var userAgent=window.navigator.userAgent;return userAgent.indexOf("iPhone")>=0}();var $selectHongBao=$("#selectHongBao"),$hongbao_not=$("#hongbao_not"),$hongbao_yes=$("#hongbao_yes"),$pageHbMoney=$("#pageHbMoney"),$actural_money=$("#actural_money"),$add_raise=$("#add_raise");this.setMesAndPacket=function(){var self=this,url=this.url.wapUrl+this.url.packetList,account=$("#cashNum").val(),param={borrow_id:this.borrow_id,account:account,currentPage:1,pernum:1};$.ajax({url:url,type:"get",dataType:"jsonp",data:param,success:function(data){if(data.result)if(data.hongbaoList.length>0){var hongbao=data.hongbaoList[0],money=(hongbao.name,hongbao.money),id=hongbao.id,rate=self.calRate(money,1*account);$selectHongBao.attr("data-id",id),$pageHbMoney.text(money),$hongbao_not.addClass("hide"),$hongbao_yes.removeClass("hide"),$actural_money.text(1*account+1*money),$add_raise.text(rate)}else self.initPacket();else data.code==-1&&$("#buyNow").attr("data-timeout",1),self.initPacket()}})},this.initPacket=function(){var account=$("#cashNum").val().trim();$selectHongBao.attr("data-id",""),$pageHbMoney.text("0"),""==account?$hongbao_not.text("输入购买金额后匹配红包"):$hongbao_not.text("暂无匹配红包"),$hongbao_not.removeClass("hide"),$hongbao_yes.addClass("hide"),$actural_money.text("0"),$add_raise.text("0%")},this.init(),this.inputMoney(),this.buyNow(),this.selectRedPacket()};App.prototype={init:function(){$("body").on("click",".tap-link",function(e){e.preventDefault(),e.stopPropagation();var href=$(this).attr("data-href");window.location.href=href}),$("body").on("click",".layermbtn span[type='0']",function(){layer.closeAll()})},inputMoney:function(){function setBuyBtnStatus(){var checked=checkAll(),moneyVal=$inpMoney.val();checked?($buyNowBtn.removeClass("disabled"),self.setMesAndPacket(moneyVal)):($buyNowBtn.addClass("disabled"),self.initPacket())}function checkAll(){var moneyVal=$inpMoney.val();return!!moneyReg.test(moneyVal)&&(moneyVal*=1,!(moneyVal<100))}var self=this,$inpMoney=$("#cashNum"),$buyNowBtn=$("#buyNow"),moneyReg=/^\d+\.\d+|\d+$/;$inpMoney.on("input",setBuyBtnStatus),setBuyBtnStatus()},buyNow:function(){var self=this;template=require("artTemplate"),require("layer");var $cashNumInp=$("#cashNum"),$buyNowBtn=$("#buyNow"),inputTpl=template.compile($("#inputPwdTpl").html());$buyNowBtn.on("click",function(){if($(this).hasClass("disabled"))return!1;var money=1*$cashNumInp.val().trim(),account=1*$("#userMoney").text().trim();if(money>account){var html="<p class='text-center lh-40'>购买金额大于可用余额，无法购买</p>";return self.tipAlert(html),!1}if(1==$(this).attr("data-timeout")){var html="<p class='text-center lh-40'>访问已超时，请重新登录！</p>";return self.tipAlert(html),setTimeout(function(){var href=self.url.wapUrl+"/passport/login.html";window.location.href=href},2e3),!1}var data={money:$("#cashNum").val(),itemName:$("#curBorrowName").val()};$(".layermcont .payPwdInput").focus();var html=inputTpl(data);layer.open({title:["请输入交易密码"],content:html,type:1,className:"paddingBottom white_header",shadeClose:!1,btn:["确认支付","取消"],yes:function(a){var parms={borrow_id:self.borrow_id,money:$cashNumInp.val(),hongbao_id:$("#selectHongBao").attr("data-id"),userPaypassword:$(".layermcont .payPwdInput").val()},url=self.url.wapUrl+self.url.buyBorrow;$.ajax({url:url,type:"get",dataType:"jsonp",data:parms,success:function(data){if(data.result)if(1==data.code){var href=self.url.wapUrl+"/financing/success.html?addRaise="+$("#add_raise").text();window.location.href=href}else{var html="<p class='text-center lh-40'>"+data.msg+"</p>";self.tipAlert(html)}else if("-1"==data.code){var html="<p class='text-center lh-40'>"+data.msg+"</p>";self.tipAlert(html),setTimeout(function(){var href=self.url.wapUrl+"/passport/login.html";window.location.href=href},2e3)}else if("-2"==data.code){var html="<p class='text-center lh-40'>"+data.msg+"</p>";self.tipAlert(html)}else{var href=self.url.wapUrl+"/financing/fail.html?failReason="+data.msg+"&code="+data.code+"&borrow_id="+self.borrow_id;window.location.href=href}}})},success:function(){function setCss(){$layermmain.css({position:"absolute",top:"10%"}),$laymshade.css({position:"absolute",width:"100%",height:$docH}),$layermbox.css({position:"absolute",top:0,left:0,right:0,bottom:0,height:$(window).height(),width:$(window).width()})}function resetCss(){$layermmain.css({position:"fixed",top:"0",left:"0",width:"100%",height:"100%"}),$laymshade.css({position:"fixed",width:"100%",height:"100%"}),$layermbox.css({position:"relative",top:0,left:0})}var $layermmain=$(".layermmain"),$laymshade=$(".laymshade"),$layermbox=$(".layermbox"),$docH=$(document).height();$(".layermbox input").focus(function(){self.isIos&&($("body").scrollTop(0),setCss())}).blur(function(){resetCss()})}})})},selectRedPacket:function(){var self=this,hongbaoTpl=template.compile($("#hongbaoListTpl").html()),$loadingImg=$("#loading_img"),$pageHbMoney=$("#pageHbMoney"),$acturalMoney=$("#actural_money"),$addRaise=$("#add_raise"),$selectHongBao=$("#selectHongBao");$selectHongBao.on("click",function(){var canBuy=!$("#buyNow").hasClass("disabled");if(!canBuy){var html="<p class='text-center lh-40'>请输入购买金额</p>";return self.tipAlert(html),!1}var data={hongbaoList:[]},html=hongbaoTpl(data);layer.open({style:"height:10rem;",content:html,className:"hongbaoScroll",type:1,shadeClose:!1,success:function(){var $layerCont=$("body .layermmain .layermcont"),src=$loadingImg.attr("src"),div=$("<div class='text-center alert_hb_loading_wraper'>"),img=$("<img class='loading'>").attr("src",src);div.append(img),$layerCont.find(".hongbao_wraper").remove(),$("body .layermmain .layermcont").append(div)}});var selectedHbId=$selectHongBao.attr("data-id"),url=self.url.wapUrl+self.url.packetList,param={borrow_id:self.borrow_id,account:$("#cashNum").val(),currentPage:1,pernum:99e4};$.ajax({url:url,type:"get",dataType:"jsonp",data:param,success:function(data){var $layerContent=$("body .layermmain .layermcont"),$hbLoadingWraper=$layerContent.find(".alert_hb_loading_wraper");if(data.result){var length=data.hongbaoList.length;if(length>0){data.hongbaoList.forEach(function(item,index){if(item.id==selectedHbId)return item.selected=1,!1});var html=hongbaoTpl(data);$layerContent.html(html)}else{var p="<p>"+data.msg+"</p>";$hbLoadingWraper.html(p)}}else if(data.code==-1){var p="<p>访问已超时，请重新登录！</p>";$hbLoadingWraper.html(p),setTimeout(function(){var href=self.url.wapUrl+"/passport/login.html";window.location.href=href},2e3)}else{var p="<p>"+data.msg+"</p>";$hbLoadingWraper.append(p)}}})}),$("body").on("click",".layermmain #closeHongBaoBtn",function(){layer.closeAll()}),$("body").on("click",".layermcont .hongbao_li",function(){function getAlertHongBaoMes(){var hongbaoMes={};return $(".layermcont .hongbao_wraper .hongbao_li").each(function(index,elem){var $hbItem=$(elem);if($hbItem.hasClass("active")){var hongbaoId=$hbItem.attr("data-id"),hongbaoMoney=$hbItem.attr("data-money"),rateHike=$hbItem.attr("data-rateHike");return hongbaoMes.id=hongbaoId,hongbaoMes.money=hongbaoMoney,hongbaoMes.rateHike=rateHike,!1}}),hongbaoMes.id?hongbaoMes:{id:"",money:"0",rateHike:"0%"}}$(this).hasClass("active")?$(this).removeClass("active"):($(".layermcont .hongbao_li").removeClass("active"),$(this).addClass("active"));var hbMes=getAlertHongBaoMes();$pageHbMoney.text(hbMes.money),$selectHongBao.attr("data-id",hbMes.id);var acturalMoney=parseInt(hbMes.money)+1*$("#cashNum").val().trim(),addRaise=self.calRate(hbMes.money,1*$("#cashNum").val().trim());$acturalMoney.text(acturalMoney),$addRaise.text(addRaise),$(this).hasClass("active")&&setTimeout(function(){layer.closeAll()},50)})}};new App})});