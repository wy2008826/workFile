define(function(require,module,exports){require("zepto"),require("fastclick"),FastClick.attach(document.body),$(function(){var App=function(){this.url={wapUrl:$("#wapurl").val(),getCodeUrl:"/api/getPhoneRegCode.html",submitUrl:"/api/passport/retrievePassword.html"},this.alertMsg={imgIsEmpty:"<p class='text-center lh-40'>验证码不能为空</p>",imgIsError:"<p class='text-center lh-40'>抱歉，您输入的图形验证码不正确</p>",mesIsError:"<p class='text-center lh-40'>抱歉，您输入的验证码不正确，可以点击“重发”再次获取短信</p>",passNotRight:"<p class='text-center lh-40'>抱歉，您输入的交易密码格式不正确，请输入6-15位数字加字母组合，区分大小写</p>",passIsNotEqual:"<p class='text-center lh-40'>两次输入的交易密码不一致</p>"},this.alertMes=function(html){layer.open({content:html,shadeClose:!1,type:1,className:"hasPadding",btn:["好的"]})},this.tipAlert=function(html){layer.open({content:html,className:"layer-tip",time:2,shadeClose:!1})},this.pagePhone=$("#pagePhone").text().trim(),this.init(),this.refeshImgAndCode(),this.validateForm()};App.prototype={init:function(){$("body").on("click",".layermbtn span",function(){layer.closeAll()}),$("input").focus(function(){var $inp=$(this);$inp.closest(".list_item").addClass("active")}),$("input").blur(function(elem){var $inp=$(this);$inp.closest(".list_item").removeClass("active")})},refeshImgAndCode:function(){function setTimer(){var timeInner=timeout;$getCode.addClass("disabled").text(timeInner+"s");var timer=setInterval(function(){timeInner-=1,$getCode.text(timeInner+"s"),0==timeInner&&($kefuMes.removeClass("hide"),$getCode.removeClass("disabled").text("重发"),clearInterval(timer))},1e3)}var self=this,$imgRandomWraper=$("#img_random_wraper"),$imgRandom=$("#img_random"),$refeshImg=$("#refresh_img"),$getCode=$("#getCode"),$passportSea=$("#passportSea"),$pwdInput0=$("#pwdInput0"),$pwdInput1=$("#pwdInput1"),$kefuMes=$("#kefuMes");$imgRandomWraper.on("click",function(){function imgLoaded(){$refeshImg.removeClass("animate")}if(!$refeshImg.hasClass("animate")){$imgRandom.unbind("load");var oldSrc=$imgRandom.attr("src").split("?")[0],now=1*new Date;$imgRandom.attr("src",oldSrc+"?"+now),$refeshImg.addClass("animate"),$imgRandom.on("load",imgLoaded.bind($imgRandom[0]))}}),$getCode.on("click",function(){var imgReg=/^\d{4,4}$/,url=self.url.wapUrl+self.url.getCodeUrl,verifyCode=$("#imgInput").val().trim(),params={Phone:self.pagePhone,verify:verifyCode,type:2};if(!$(this).hasClass("disabled")){if(!verifyCode){var html="<p class='text-center lh-40'>图形验证码不能为空</p>";return self.tipAlert(html),!1}if(!imgReg.test(verifyCode)){var html="<p class='text-center lh-40'>图形验证码格式不正确</p>";return self.tipAlert(html),!1}$.ajax({url:url,type:"get",dataType:"jsonp",data:params,success:function(data){if("string"==typeof data&&(data=$.parseJSON(data)),data.result)setTimer();else{if(2==data.status){var html="<p class='lh-40'>"+data.msg+"</p>";return self.alertMes(html),!1}var html="<p class='lh-40'>"+data.msg+"</p>";self.alertMes(html)}},error:function(){}})}}),$passportSea.on("click",function(){var type=$pwdInput0.attr("type");"text"==type?($pwdInput0.attr("type","password"),$pwdInput1.attr("type","password"),$passportSea.removeClass("icon-kejian").addClass("icon-bukejian")):($pwdInput0.attr("type","text"),$pwdInput1.attr("type","text"),$passportSea.removeClass("icon-bukejian").addClass("icon-kejian"))});var timeout=60},validateForm:function(){function validateAll(){var imgVal=$imgInput.val().trim(),telMesVal=$telMesInput.val().trim(),pswVal0=$pwdInput0.val().trim(),pswVal1=$pwdInput1.val().trim();return""!=imgVal&&""!=telMesVal&&""!=pswVal0&&""!=pswVal1&&!!imgReg.test(imgVal)}function submitSuccess(){var html="<p class='text-center'>交易密码修改成功</p>",url=self.url.wapUrl+"/member/setting.html";layer.open({content:html,shadeClose:!1,className:"layer-tip",time:2,end:function(){window.location.href=url}})}require("layer");var self=this,regPass=/^(?![0-9]+$)(?![a-zA-Z]+$)[0-9A-Za-z]{6,15}$/,imgReg=/^\d{4,4}$/,$imgInput=($("#imgRow"),$("#imgInput")),$telMesInput=$("#telMesInput"),$pwdInput0=$("#pwdInput0"),$pwdInput1=$("#pwdInput1"),$submit=$("#submit");$("input").on("input",function(){var validated=($(this),validateAll());validated?$submit.removeClass("disabled"):$submit.addClass("disabled")}),$submit.click(function(){if(!$submit.hasClass("disabled")){if($pwdInput0.val()!=$pwdInput1.val()){var html=self.alertMsg.passIsNotEqual;return self.alertMes(html),!1}if(!regPass.test($pwdInput0.val())||!regPass.test($pwdInput1.val())){var html=self.alertMsg.passNotRight;return self.alertMes(html),!1}var params={userName:self.pagePhone,vertify:$imgInput.val(),code:$telMesInput.val(),firstPwd:$pwdInput0.val(),secondPwd:$pwdInput1.val()};$.ajax({url:self.url.wapUrl+self.url.submitUrl,type:"get",dataType:"jsonp",data:params,success:function(data){if(data.result)data.result&&submitSuccess();else{if(2==data.status)var html=self.alertMsg.imgIsError;else if(1==data.status){var text=$("#getCode").text();text.search("s")>=0&&(text="重发");var html="<p class='lh-40'>抱歉，您输入的验证码不正确，可以点击“"+text+"”再次获取短信</p>"}else if(data.code==-1){var html="<p class='text-center lh-40'>访问已超时，请重新登录！</p>";self.alertMes(html),setTimeout(function(){var href=self.url.wapUrl+"/passport/login.html";window.location.href=href},2e3)}else var html=self.alertMsg.passIsNotEqual;self.alertMes(html)}}})}})},submitForm:function(){}};new App})});